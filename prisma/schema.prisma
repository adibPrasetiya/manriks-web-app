generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String          @id @default(cuid())
  username           String          @unique @db.VarChar(255)
  name               String          @db.VarChar(255)
  email              String          @unique @db.VarChar(255)
  password           String          @db.VarChar(255)
  isActive           Boolean         @default(false)
  isVerified         Boolean         @default(false)
  passwordChangedAt  DateTime?
  mustChangePassword Boolean         @default(false)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  userRoles          UserRole[]
  session            Session?
  profile            Profile?
  riskWorksheets     RiskWorksheet[] @relation("WorksheetOwner")

  // Relations for worksheet submission and approval
  submittedWorksheets RiskWorksheet[] @relation("WorksheetSubmitter")
  approvedWorksheets  RiskWorksheet[] @relation("WorksheetApprover")

  // Relations for mitigation validation
  validatedMitigations RiskMitigation[] @relation("MitigationValidator")

  @@index([email])
  @@index([username])
  @@index([isActive, isVerified])
  @@map("users")
}

model Role {
  id          String     @id @default(cuid())
  name        RoleName   @unique
  description String?    @db.Text
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  userRoles   UserRole[] // Many-to-many dengan User

  @@map("roles")
}

model UserRole {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleId     String
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  assignedAt DateTime @default(now())

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

model Session {
  id           String   @id @default(cuid())
  userId       String   @unique // User hanya bisa punya 1 session aktif
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  refreshToken String   @unique @db.VarChar(500) // Refresh token (hashed)
  deviceId     String   @db.VarChar(255) // Device identifier untuk tracking
  deviceName   String?  @db.VarChar(255) // Nama device (misal: "Chrome on Windows")
  userAgent    String?  @db.Text // User agent string
  ipAddress    String?  @db.VarChar(45) // IPv4 atau IPv6
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([refreshToken])
  @@index([expiresAt])
  @@map("sessions")
}

model UnitKerja {
  id        String    @id @default(cuid())
  name      String    @db.VarChar(255)
  code      String    @unique @db.VarChar(100)
  email     String    @db.VarChar(255)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  profiles  Profile[]
  assets    Asset[]

  // Relations for change requests
  profileChangeRequests ProfileChangeRequest[]

  // Relations for risk worksheets
  riskWorksheets RiskWorksheet[]

  @@index([code])
  @@map("unit_kerja")
}

model Profile {
  id          String    @id @default(cuid())
  userId      String    @unique // One-to-one dengan User
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  jabatan     String    @db.VarChar(255)
  unitKerjaId String
  unitKerja   UnitKerja @relation(fields: [unitKerjaId], references: [id], onDelete: Restrict)
  nomorHP     String?   @db.VarChar(20) // Optional

  // Verification fields
  isVerified Boolean   @default(false)
  verifiedAt DateTime?
  verifiedBy String? // userId admin yang memverifikasi

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  changeRequests ProfileChangeRequest[]

  @@index([userId])
  @@index([unitKerjaId])
  @@index([isVerified])
  @@map("profiles")
}

enum RoleName {
  USER
  ADMINISTRATOR
  KOMITE_PUSAT
  PENGELOLA_RISIKO_UKER
}

enum AssetStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum ProfileRequestType {
  INITIAL_VERIFICATION
  CHANGE
}

enum ProfileRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RiskWorksheetStatus {
  DRAFT
  SUBMITTED
  APPROVED
  ARCHIVED
}

enum MitigationStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum MitigationValidationStatus {
  PENDING
  VALIDATED
  REJECTED
}

enum MitigationPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TreatmentOption {
  ACCEPT
  MITIGATE
  TRANSFER
  AVOID
}

model ProfileChangeRequest {
  id        String  @id @default(cuid())
  profileId String
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  requestType ProfileRequestType @default(CHANGE)

  // Data yang diminta untuk diubah
  jabatan     String?    @db.VarChar(255)
  unitKerjaId String?
  unitKerja   UnitKerja? @relation(fields: [unitKerjaId], references: [id], onDelete: Restrict)
  nomorHP     String?    @db.VarChar(20)

  status          ProfileRequestStatus @default(PENDING)
  rejectionReason String?              @db.Text

  requestedAt DateTime  @default(now())
  processedAt DateTime?
  processedBy String? // userId admin yang memproses

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([profileId])
  @@index([status])
  @@index([requestType])
  @@index([requestedAt])
  @@map("profile_change_requests")
}

enum KonteksStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

model Konteks {
  id          String  @id @default(cuid())
  name        String  @db.VarChar(255)
  code        String  @unique @db.VarChar(100)
  description String? @db.Text

  // Periode konteks (tahun)
  periodStart Int // Tahun mulai, misal: 2024
  periodEnd   Int // Tahun akhir, misal: 2025

  // Matrix size (ukuran matriks risiko, e.g., 5 = 5x5)
  matrixSize Int @default(5)

  // Menandakan konteks yang disediakan sistem vs buatan pengguna
  isSystemDefault Boolean @default(false)

  // Risk Appetite (simple fields)
  riskAppetiteLevel       String? @db.VarChar(100) // e.g., "MEDIUM", "HIGH"
  riskAppetiteDescription String? @db.Text

  // Status
  status KonteksStatus @default(INACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String? // userId KOMITE_PUSAT yang buat
  updatedBy String? // userId KOMITE_PUSAT yang update terakhir

  // Relations
  riskCategories RiskCategory[]
  riskMatrices   RiskMatrix[]
  riskWorksheets RiskWorksheet[]

  @@index([code])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@index([isSystemDefault])
  @@map("konteks")
}

model RiskCategory {
  id        String  @id @default(cuid())
  konteksId String
  konteks   Konteks @relation(fields: [konteksId], references: [id], onDelete: Cascade)

  name        String  @db.VarChar(255) // e.g., "Risiko Fisik", "Risiko SDM"
  description String? @db.Text
  order       Int     @default(0) // Display order

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  likelihoodScales    LikelihoodScale[]
  impactScales        ImpactScale[]
  riskAssessmentItems RiskAssessmentItem[]

  @@unique([konteksId, order])
  @@index([konteksId])
  @@map("risk_categories")
}

model LikelihoodScale {
  id             String       @id @default(cuid())
  riskCategoryId String
  riskCategory   RiskCategory @relation(fields: [riskCategoryId], references: [id], onDelete: Cascade)

  level       Int // 1, 2, 3, 4, 5 (or 1-10)
  label       String @db.VarChar(100) // e.g., "Sangat Jarang", "Jarang"
  description String @db.Text // e.g., "< 5% kemungkinan terjadi"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([riskCategoryId, level]) // Each level must be unique per risk category
  @@index([riskCategoryId])
  @@map("likelihood_scales")
}

model ImpactScale {
  id             String       @id @default(cuid())
  riskCategoryId String
  riskCategory   RiskCategory @relation(fields: [riskCategoryId], references: [id], onDelete: Cascade)

  level       Int // 1, 2, 3, 4, 5 (or 1-10)
  label       String @db.VarChar(100) // e.g., "Tidak Signifikan", "Minor"
  description String @db.Text // e.g., "Dampak minimal"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([riskCategoryId, level]) // Each level must be unique per risk category
  @@index([riskCategoryId])
  @@map("impact_scales")
}

model RiskMatrix {
  id        String  @id @default(cuid())
  konteksId String
  konteks   Konteks @relation(fields: [konteksId], references: [id], onDelete: Cascade)

  likelihoodLevel Int // 1-5 (or 1-10)
  impactLevel     Int // 1-5 (or 1-10)
  riskLevel       String @db.VarChar(50) // "LOW", "MEDIUM", "HIGH", "CRITICAL"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([konteksId, likelihoodLevel, impactLevel]) // Each combination unique per konteks
  @@index([konteksId])
  @@index([konteksId, riskLevel])
  @@map("risk_matrices")
}

model AssetCategory {
  id          String   @id @default(cuid())
  name        String   @unique @db.VarChar(100)
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  assets      Asset[]

  @@map("asset_categories")
}

model Asset {
  id          String        @id @default(cuid())
  unitKerjaId String
  unitKerja   UnitKerja     @relation(fields: [unitKerjaId], references: [id], onDelete: Restrict)
  categoryId  String
  category    AssetCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  name        String      @db.VarChar(255)
  code        String      @db.VarChar(100)
  description String?     @db.Text
  owner       String?     @db.VarChar(255)
  status      AssetStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  // Relations
  riskAssessmentItems RiskAssessmentItem[]

  @@unique([unitKerjaId, code])
  @@index([unitKerjaId])
  @@index([categoryId])
  @@index([status])
  @@map("assets")
}

model RiskWorksheet {
  id          String    @id @default(cuid())
  unitKerjaId String
  unitKerja   UnitKerja @relation(fields: [unitKerjaId], references: [id], onDelete: Restrict)
  konteksId   String
  konteks     Konteks   @relation(fields: [konteksId], references: [id], onDelete: Restrict)
  ownerId     String
  owner       User      @relation("WorksheetOwner", fields: [ownerId], references: [id], onDelete: Restrict)

  name        String              @db.VarChar(255)
  description String?             @db.Text
  status      RiskWorksheetStatus @default(DRAFT)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Submission tracking
  submittedAt DateTime?
  submittedBy String?
  submitter   User?     @relation("WorksheetSubmitter", fields: [submittedBy], references: [id], onDelete: Restrict)

  // Approval tracking (KOMITE_PUSAT)
  approvedAt    DateTime?
  approvedBy    String?
  approver      User?     @relation("WorksheetApprover", fields: [approvedBy], references: [id], onDelete: Restrict)
  approvalNotes String?   @db.Text

  // Relations
  riskAssessmentItems RiskAssessmentItem[]

  @@unique([unitKerjaId, konteksId, name])
  @@index([unitKerjaId])
  @@index([konteksId])
  @@index([ownerId])
  @@index([submittedBy])
  @@index([approvedBy])
  @@index([status])
  @@map("risk_worksheets")
}

model RiskAssessmentItem {
  id          String        @id @default(cuid())
  worksheetId String
  worksheet   RiskWorksheet @relation(fields: [worksheetId], references: [id], onDelete: Cascade)

  riskCode       String       @db.VarChar(50)
  riskName       String       @db.VarChar(255)
  assetId        String
  asset          Asset        @relation(fields: [assetId], references: [id], onDelete: Restrict)
  riskCategoryId String
  riskCategory   RiskCategory @relation(fields: [riskCategoryId], references: [id], onDelete: Restrict)

  // Risk Description (kelemahan, ancaman, dampak)
  weaknessDescription String? @db.Text
  treatDescription    String? @db.Text
  impactDescription   String? @db.Text

  // Inherent Risk (risiko bawaan - sebelum kontrol)
  inherentLikelihood            Int
  inherentImpact                Int
  inherentLikelihoodDescription String? @db.Text
  inherentImpactDescription     String? @db.Text
  inherentRiskLevel             String  @db.VarChar(50)

  // Control Assessment
  existingControls     String? @db.Text
  controlEffectiveness String? @db.VarChar(50)

  // Residual Risk (risiko saat ini - diupdate saat mitigasi disetujui)
  residualLikelihood            Int?
  residualImpact                Int?
  residualLikelihoodDescription String? @db.Text
  residualImpactDescription     String? @db.Text
  residualRiskLevel             String? @db.VarChar(50)

  // Treatment & Priority
  treatmentOption    String? @db.VarChar(50)
  treatmentRationale String? @db.Text
  riskPriorityRank   Int?

  order Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  mitigations RiskMitigation[]

  // Extensibility
  metadata Json?

  @@unique([worksheetId, riskCode])
  @@index([worksheetId])
  @@index([riskCategoryId])
  @@index([assetId])
  @@index([inherentRiskLevel])
  @@index([residualRiskLevel])
  @@map("risk_assessment_items")
}

model RiskMitigation {
  id     String             @id @default(cuid())
  itemId String
  item   RiskAssessmentItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  code        String  @db.VarChar(50)
  name        String  @db.VarChar(255)
  description String? @db.Text

  priority         MitigationPriority @default(MEDIUM)
  plannedStartDate DateTime?
  plannedEndDate   DateTime?
  actualStartDate  DateTime?
  actualEndDate    DateTime?

  responsiblePerson String? @db.VarChar(255)
  responsibleUnit   String? @db.VarChar(255)

  status             MitigationStatus @default(PLANNED)
  progressPercentage Int              @default(0)
  progressNotes      String?          @db.Text

  // Proposed Residual Risk - nilai yang diajukan pengelola
  proposedResidualLikelihood            Int
  proposedResidualImpact                Int
  proposedResidualLikelihoodDescription String? @db.Text
  proposedResidualImpactDescription     String? @db.Text
  proposedResidualRiskLevel             String  @db.VarChar(50)

  // Validasi oleh KOMITE_PUSAT
  validationStatus MitigationValidationStatus @default(PENDING)
  validatedAt      DateTime?
  validatedBy      String?
  validator        User?                      @relation("MitigationValidator", fields: [validatedBy], references: [id], onDelete: SetNull)
  validationNotes  String?                    @db.Text
  isValidated      Boolean                    @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String
  updatedBy String?

  // Extensibility
  metadata Json?

  @@unique([itemId, code])
  @@index([itemId])
  @@index([status])
  @@index([priority])
  @@index([isValidated])
  @@index([validationStatus])
  @@index([validatedBy])
  @@map("risk_mitigations")
}
